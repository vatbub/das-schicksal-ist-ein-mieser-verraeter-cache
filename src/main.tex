% Preamble
\documentclass[12pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

% Translation
\input{translation-german.tex}

% Document font
\usepackage{courier}

% Margins
\usepackage[a4paper, top=2.5cm, bottom=2cm, left=2.5cm, right=2.5cm]{geometry}
\setlength{\parindent}{0pt}
\setlength{\parskip}{\baselineskip}

% Packages
\usepackage{glossaries}
\usepackage{changepage}
\usepackage{xparse}
\usepackage{titling}
\usepackage{array}
\usepackage{enumerate}
\usepackage[shortlabels]{enumitem}
\usepackage{titlesec}
\usepackage{calc}

% For title slug
\newcolumntype{P}[1]{>{\centering\arraybackslash}p{#1}}

% Section header formatting
%! suppress = MissingLabel
\titleformat{\section}{}{}{0em}{\MakeUppercase}

\makeglossaries

% Appearance of characters
\newcommand{\character}[2][\translationDefaultCharacterDescription]{\newacronym{#2}{#2}{#1}}
\newacronymstyle{screenplay-characters}
{%
    \GlsUseAcrEntryDispStyle{short-long}%
}
{%
    \GlsUseAcrStyleDefs{short-long}%
    \renewcommand{\firstacronymfont}[1]{\MakeUppercase{##1}}%
    %
    % No case change, singular first use:
    \renewcommand*{\genacrfullformat}[2]{%
        \firstacronymfont{\glsentryshort{##1}}%
    }%
    % First letter upper case, singular first use:
    \renewcommand*{\Genacrfullformat}[2]{%
        \firstacronymfont{\Glsentryshort{##1}}%
    }%
    % No case change, plural first use:
    \renewcommand*{\genplacrfullformat}[2]{%
        \firstacronymfont{\glsentryshortpl{##1}}%
    }%
    % First letter upper case, plural first use:
    \renewcommand*{\Genplacrfullformat}[2]{%
        \firstacronymfont{\Glsentryshortpl{##1}}%
    }%
}

\setacronymstyle{screenplay-characters}

% Elements of a scene
\newenvironment{scene}[4][\unskip]{
    \textbf{\uppercase{#1}}


    \section{#2 #3 -- #4}\label{sec:scene-#3}
    }{}
\newenvironment{scenedescription}{%
    \begin{flushleft}
    }{
    \end{flushleft}
}

\newcommand{\actionline}[1]{#1}

% Dialog elements
\NewDocumentEnvironment{dialog} { o m } {
    \begin{adjustwidth}{6.5cm}{0cm}
        \uppercase{#2}\IfValueT{#1}{\uppercase{~(#1)}}
    \end{adjustwidth}
    \begin{adjustwidth}{2.5cm}{0cm}
        \begin{flushleft}
        }{
        \end{flushleft}
    \end{adjustwidth}
}

% Decision elements
\newlist{optionlist}{enumerate}{3}
\setlist[optionlist]{
    font=\bfseries,
    align=left
}
\setlist[optionlist, 1]{
    label=\translationOptionLabel~\arabic*:,
    ref=\arabic*
}
\setlist[optionlist, 2]{
    label=\translationOptionLabel~\theoptionlisti.\arabic*:,
    ref=\theoptionlisti.\arabic*
}
\setlist[optionlist, 3]{
    label=\translationOptionLabel~\theoptionlisti.\theoptionlistii.\arabic*:,
    ref=\theoptionlisti.\theoptionlistii.\arabic*
}

\newcounter{DecisionEnvironmentDepth}
\setcounter{DecisionEnvironmentDepth}{0}
\newcounter{decision}
\newenvironment{decision}[2]{
    \refstepcounter{decision}
    \addtocounter{DecisionEnvironmentDepth}{1}% increment depth
    \expandafter\newcommand\csname DecisionLabel\the\value{DecisionEnvironmentDepth} \endcsname{#1}
    \label{#1}
    \par\textbf{\translationDecisionLabel~\thedecision:}~#2
    \begin{optionlist}
    }{
    \end{optionlist}
    \addtocounter{DecisionEnvironmentDepth}{-1}% decrement depth
}

\newlength{\enumerateIndent}
\setlength{\enumerateIndent}{-1cm}
\newcounter{OptionEnvironmentDepth}
\setcounter{OptionEnvironmentDepth}{0}
\newcommand{\currentOptionLabel}{}
\newenvironment{option}[2]{
    \renewcommand{\currentOptionLabel}{#1}
    \addtocounter{OptionEnvironmentDepth}{1}% increment depth
    \item \label{#1} #2
    \begin{adjustwidth}{\enumerateIndent}{0cm*\value{OptionEnvironmentDepth}}
    }{
    \end{adjustwidth}
    \textit{(\translationEndOfBranch~\translationDecisionLabel~\ref{\csname DecisionLabel\the\value{DecisionEnvironmentDepth} \endcsname},~\translationOptionLabel~\ref{\currentOptionLabel})}
    \addtocounter{OptionEnvironmentDepth}{-1}% decrement depth
}

\newcounter{ConditionalEnvironmentDepth}
\setcounter{ConditionalEnvironmentDepth}{0}
\newcounter{conditional}
\newenvironment{conditional}[2]{
    \refstepcounter{conditional}
    \addtocounter{ConditionalEnvironmentDepth}{1}% increment depth
    \expandafter\newcommand\csname ConditionalCounter\the\value{ConditionalEnvironmentDepth} \endcsname{\theconditional}
    \textbf{\translationConditionalLabel~\theconditional:} \translationBeginningOfConditional~\translationDecisionLabel~\ref{#1}, \translationOptionLabel~\ref{#2}:
        }{
    \textit{(\translationEndOfBranch~\translationConditionalLabel~\csname ConditionalCounter\the\value{ConditionalEnvironmentDepth} \endcsname.)}
    \addtocounter{ConditionalEnvironmentDepth}{-1}% decrement depth
}

% Characters
\input{characters.tex}

% Title
\title{Das Schicksal ist ein mieser Verräter}
\author{Frederik Kammel}
\newcommand{\BasedOn}{Das Schicksal ist ein mieser Verräter, John Green}
\newcommand{\TitleSlug}{Stell dir vor, dein Leben liegt in Trümmern. \newline Der letzte Kuss ist Jahre her.}

% Document
\begin{document}

    \fontfamily{pcr}\selectfont

    \begin{titlepage}
        \centering
        \vglue6cm
        „\MakeUppercase{\thetitle}“

        \vspace{2cm}
        \translationWrittenBy

        \theauthor

        \vspace{2cm}
        \translationBasedOn

        \BasedOn

        \ifdefined\TitleSlug
        \vspace{2cm}

        \begin{adjustwidth}{1cm}{1cm}
            \begin{center}
                \begin{tabular}{ P{13cm} }
                    \hline
                    \textit{\TitleSlug} \\
                    \hline
                \end{tabular}
            \end{center}
        \end{adjustwidth}
        \fi
    \end{titlepage}


    \begin{scene}[fade in]{innen}{Verhör}{Tageszeit unbekannt}
        \begin{scenedescription}
            \gls{Emma}, eine 40 Jahre alte Frau mit faltigem Gesicht sitzt an einem Tisch.
            Ihr gegenüber sitzt ein \gls{Polizist}, auf dem Tisch stehen zwei Mikrofone, eines zeigt zum \gls{Polizist}en, eines zu Emma.
            Das Licht fällt so, dass der Tisch gut sichtbar und die Gesichter der Personen gerade so sichtbar sind.
            Der Rest des Raumes ist schwarz.
        \end{scenedescription}

        \begin{dialog}{Polizist}
            Sie wissen, warum Sie hier sind?
        \end{dialog}

        \actionline{\gls{Emma} schweigt.}

        \begin{dialog}[Fortsetzung]{Polizist}
            Sie müssen mir nichts sagen, aber wenn Sie schweigen, werden wir Sie bis auf Weiteres festnehmen müssen.
        \end{dialog}
    \end{scene}

    \begin{scene}{aussen}{Flashback}{tagsüber}
        \begin{scenedescription}
            \gls{Emma} liegt auf dem Boden und wird von einer anderen Person erwürgt.
            \gls{Emma} schreit und versucht, sich aus dem Würgegriff zu befreien, in ihrem Blick ist die Angst vor dem Tod deutlich zu sehen.
        \end{scenedescription}
    \end{scene}

    \begin{scene}{innen}{Verhör (Fortsetzung)}{Tageszeit unbekannt}
        \begin{dialog}{Emma}
            Ich war es nicht.
            Er war es!
        \end{dialog}

        \begin{dialog}{Polizist}
            Und wer ist „er“?
        \end{dialog}

        \actionline{Emma spielt mit ihren Händen (Beat).}

        \begin{dialog}{Emma}
            Wenn ich Ihnen das sage, wird er Sie töten.
        \end{dialog}

        \begin{dialog}{Polizist}
            Hier sage ich etwas sehr langes, damit der Zeilenumbruch im Dialog sichtbar wird.
            Das ist echt schwierig, denn es soll ja einen Inhalt haben, aber gleichzeitig bin ich sehr unkreativ.
            Technische Dinge eben.
            Vieleicht sollte ich eher einen Lorem Ipsum Text kopieren.
        \end{dialog}

        \begin{decision}{erste-entscheidung}{Eine Beispielentscheidung}
            \begin{option}{test-label}{Test}
                \begin{dialog}{Emma}
                    Hier spreche ich eine Option.
                    Die Option ist sehr lange, weil auch ich einen Zeilenumbruch testen soll.
                    Haha, wie einfach.
                \end{dialog}
            \end{option}
            \begin{option}{test-label-other}{Eine weitere Option}
                \begin{dialog}{Emma}
                    Und hier die zweite Option.
                \end{dialog}
            \end{option}
        \end{decision}

        \begin{decision}{zweite-entscheidung}{Eine weitere Beispielentscheidung}
            \begin{option}{more-test-label}{Test}
                \begin{dialog}{Emma}
                    Nächste Entscheidung, hier ist die erste Option.
                \end{dialog}
            \end{option}
            \begin{option}{more-test-label-other}{Eine weitere Option}
                \begin{dialog}{Emma}
                    Und hier die zweite Option der zweiten Entscheidung.
                \end{dialog}
            \end{option}
        \end{decision}

        \begin{conditional}{erste-entscheidung}{test-label}
            \begin{dialog}{Polizist}
                Leider haben Sie die falsche option bei Entscheidung~\ref{erste-entscheidung} gewählt.
            \end{dialog}
        \end{conditional}

    \end{scene}

    \begin{scene}{innen}{Verschachtelte Entscheidungen}{Tageszeit unbekannt}
        \begin{scenedescription}
            In dieser Szene geht es um die Darstellung verschachtelter Entscheidungen.
        \end{scenedescription}

        \begin{dialog}{Emma}
            Auch hier sage ich zunächst etwas sehr langes, um die Umbrüche und die Einrückung zu testen.
            Viel Spaß beim Lesen!
        \end{dialog}

        \begin{decision}{obere-ebene-verschachtelte-entscheidung}{Eine verschachtelte Entscheidung -- obere Ebene}
            \begin{option}{nested-option-1}{Erste Option}
                \begin{decision}{erste-innere-entscheidung}{Hier die erste verschachtelte Option - innen}
                    \begin{option}{innen-entscheidung-1-option1}{Innen ENtscheidung 1, Option 1}
                        \begin{dialog}{Emma}
                            Innere Entscheidung, hier ist die erste Option.
                            Der Text ist hier absichtlich lang, da jede Option aktuell weiter eingerückt ist, als die vorherige.
                            Das sollte so nicht sein, Dialog sollte immer die gleiche Einrückung haben.
                        \end{dialog}
                    \end{option}
                    \begin{option}{innen-entscheidung-1-option2}{Eine weitere innere Option}
                        \begin{dialog}{Emma}
                            Und hier die zweite Option der ersten inneren Entscheidung.
                        \end{dialog}
                    \end{option}
                \end{decision}
            \end{option}
            \begin{option}{nested-option-2}{Eine weitere äußere Option}
                \begin{decision}{zweite-innere-entscheidung}{Hier die zweite verschachtelte Option - innen}
                    \begin{option}{innen-entscheidung-2-option1}{Innen ENtscheidung 2, Option 1}
                        \begin{dialog}{Emma}
                            Zweite innere Entscheidung, hier ist die erste Option.
                        \end{dialog}
                    \end{option}
                    \begin{option}{innen-entscheidung-2-option2}{Eine weitere innere Option}
                        \begin{dialog}{Emma}
                            Und hier die zweite Option der zweiten inneren Entscheidung.
                        \end{dialog}
                    \end{option}
                \end{decision}
            \end{option}
        \end{decision}
    \end{scene}

\end{document}
